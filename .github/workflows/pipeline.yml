name: DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  # Job 1: SAST (Static Application Security Testing)
  security-scan:
    name: Analise SonarQube
    runs-on: [self-hosted, local-lab] # ⚠️ Importante: Usa seu PC, não a nuvem
    
    steps:
      - name: Checkout do Código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Importante para análises precisas

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
# ... (mantenha os passos anteriores: Checkout e SonarQube Scan) ...

      - name: SonarQube Quality Gate Check
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        # Se o Quality Gate falhar, este passo retorna erro e para o pipeline.
          # Se der erro de certificado SSL (comum em Lab), descomente abaixo:
          # SONAR_SCANNER_OPTS: "-Dsonar.verify.ssl=false"

  # Job 2: SCA (Software Composition Analysis) - Dependências
  sca-scan:
    name: Analise de Dependencias (Trivy)
    runs-on: [self-hosted, local-lab]
    needs: security-scan # Só roda se o SAST passar
    
    steps:
      - name: Checkout do Código
        uses: actions/checkout@v4

      - name: Instalar Trivy
        run: |
          if ! command -v trivy &> /dev/null; then
             sudo apt-get install wget apt-transport-https gnupg lsb-release -y
             wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
             echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
             sudo apt-get update
             sudo apt-get install trivy -y
          fi

      - name: Executar Scan de Vulnerabilidades (SCA)
        # Falha se encontrar vulnerabilidade CRITICA ou ALTA
        run: trivy fs . --severity HIGH,CRITICAL --exit-code 1
# ... (mantenha os jobs anteriores) ...

 deploy:
    name: Build, Scan e Deploy Orchestrado
    runs-on: [self-hosted, local-lab]
    needs: sca-scan
    
    steps:
      - name: Checkout do Código
        uses: actions/checkout@v4

      - name: Buscar Senha no Vault
        run: |
          export VAULT_TOKEN="${{ secrets.VAULT_TOKEN }}"
          export VAULT_ADDR="${{ secrets.VAULT_ADDR }}"
          DB_PASS=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN" $VAULT_ADDR/v1/secret/data/webapp/db | jq -r '.data.data.password')
          echo "::add-mask::$DB_PASS"
          echo "APP_DB_PASS=$DB_PASS" >> $GITHUB_ENV

      - name: Build da Imagem Docker
        run: |
          export DOCKER_BUILDKIT=1
          docker build -t minha-app:latest .

      - name: Scan de Imagem Docker (Trivy)
        run: |
          trivy image --severity CRITICAL --exit-code 1 minha-app:latest

      - name: Deploy em Produção (Docker Compose)
        run: |
          # 1. Salva a imagem
          docker save minha-app:latest > minha-app.tar
          
          # 2. Prepara diretório de config na VM
          ssh vagrant@192.168.56.20 "mkdir -p /home/vagrant/app/nginx /home/vagrant/app/certs"

          # 3. Transfere Arquivos (Imagem, Config Nginx, Docker Compose)
          scp minha-app.tar vagrant@192.168.56.20:/home/vagrant/
          scp nginx/default.conf vagrant@192.168.56.20:/home/vagrant/app/nginx/
          scp docker-compose.prod.yml vagrant@192.168.56.20:/home/vagrant/app/

          # 4. Executa Deploy Remoto
          ssh vagrant@192.168.56.20 << EOF
            cd /home/vagrant/app
            
            # Gera Certificado SSL Autoassinado (Válido por 365 dias)
            openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
              -keyout certs/nginx.key \
              -out certs/nginx.crt \
              -subj "/C=BR/ST=SP/L=SaoPaulo/O=DevSecOps/OU=IT/CN=192.168.56.20"

            # Carrega a imagem nova
            docker load < /home/vagrant/minha-app.tar
            
            # Cria arquivo .env com a senha do Vault para o Compose usar
            echo "APP_PASSWORD=${{ env.APP_DB_PASS }}" > .env
            
            # Sobe os containers (Recria se mudou algo)
            docker compose -f docker-compose.prod.yml up -d --force-recreate
            
            # Limpeza
            rm /home/vagrant/minha-app.tar
          EOF

  dast-scan:
    name: Teste Dinamico (OWASP ZAP)
    runs-on: [self-hosted, local-lab]
    needs: deploy
    steps:
      - name: Executar OWASP ZAP (Baseline Scan)
        run: |
          # Agora atacamos a porta 80/443!
          # O ZAP vai reclamar do certificado autoassinado, mas vai testar
          docker run --rm -v $(pwd):/zap/wrk/:rw -t ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t https://192.168.56.20 \
            -g gen.conf \
            -r report_https.html \
            -I || true 
            # -I ignora avisos de falha (útil para self-signed)
